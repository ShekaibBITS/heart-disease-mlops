name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

jobs:
  build_push:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.head_branch == 'main' ||
        github.event.workflow_run.head_branch == 'feadture-ap'))
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Set build variables (branch/sha + safe tag)
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
            REF="${{ github.event.workflow_run.head_sha }}"
          else
            BRANCH="${{ github.ref_name }}"
            SHA="${{ github.sha }}"
            REF="${{ github.ref_name }}"
          fi

          # Docker tag-safe branch:
          # - lowercase
          # - replace "/" with "-"
          # - replace any remaining invalid characters with "-"
          TAG_BRANCH="$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's|/|-|g' | sed 's/[^a-z0-9_.-]/-/g')"

          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "TAG_BRANCH=$TAG_BRANCH" >> $GITHUB_OUTPUT
          echo "SHA=$SHA" >> $GITHUB_OUTPUT
          echo "REF=$REF" >> $GITHUB_OUTPUT

      - name: Checkout exact ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.REF }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name
        run: |
          echo "IMAGE=ghcr.io/${{ github.repository_owner }}/heart-api" >> $GITHUB_ENV

      - name: Build & Push (branch + sha)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deployment/docker/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ steps.vars.outputs.TAG_BRANCH }}
            ${{ env.IMAGE }}:${{ steps.vars.outputs.SHA }}

      - name: Build & Push (latest - main only)
        if: ${{ steps.vars.outputs.BRANCH == 'main' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deployment/docker/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}:latest
