name: CD â€“ Build & Publish API Image

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: cd-${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: true

jobs:
  build_push:
    name: Build & Publish Container

    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Resolve build metadata
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
            REF="${{ github.event.workflow_run.head_sha }}"
          else
            BRANCH="${{ github.ref_name }}"
            SHA="${{ github.sha }}"
            REF="${{ github.sha }}"
          fi

          TAG_BRANCH="$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's|/|-|g')"

          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "SHA=$SHA" >> $GITHUB_OUTPUT
          echo "REF=$REF" >> $GITHUB_OUTPUT
          echo "TAG_BRANCH=$TAG_BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout exact commit
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.REF }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Define image name
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE=ghcr.io/${OWNER}/heart-api" >> $GITHUB_ENV

      - name: Build & Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deployment/docker/Dockerfile
          push: true
          build-args: |
            APP_ENV=nonprod
            GIT_SHA=${{ steps.vars.outputs.SHA }}
          tags: |
            ${{ env.IMAGE }}:${{ steps.vars.outputs.SHA }}
            ${{ env.IMAGE }}:${{ steps.vars.outputs.TAG_BRANCH }}

      - name: Verify image
        run: |
          docker manifest inspect ${{ env.IMAGE }}:${{ steps.vars.outputs.SHA }} > /dev/null
